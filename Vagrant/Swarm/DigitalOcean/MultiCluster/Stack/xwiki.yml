version: '3.3'
services:
 web:
  image: "xwiki:mysql-tomcat"
  ports:
   - "8080:8080"
  environment:
   - DB_USER_FILE=/run/secrets/xwiki-db-username
   - DB_PASSWORD_FILE=/run/secrets/xwiki-db-password
   - DB_DATABASE=xwiki
   - DB_HOST=db
  volumes:
   - xwiki-data:/usr/local/xwiki
  secrets:
   - xwiki-db-username
   - xwiki-db-password
 db:
  image: "mysql:5.7"
  volumes:
   - mysql-data:/var/lib/mysql
  environment:
   - MYSQL_ROOT_PASSWORD=/run/secrets/xwiki-db-root-password
   - MYSQL_USER_FILE=/run/secrets/xwiki-db-username
   - MYSQL_PASSWORD_FILE=/run/secrets/xwiki-db-password
   - MYSQL_DATABASE=xwiki
  secrets:
   - xwiki-db-username
   - xwiki-db-password
   - xwiki-db-root-password
  configs: 
   - source: mysql-config
   - target: /etc/mysql/conf.d/xwiki.cnf
volumes:
 mysql-data:
 xwiki-data:
secrets:
 xwiki-db-username:
  external:
   name: xwiki-db-username
 xwiki-db-password:
  external:
   name: xwiki-db-password
 xwiki-db-root-password:
  external:
   name: xwiki-db-root-password
configs:
 mysql-config:
  external:
   name: xwiki-mysql-config
